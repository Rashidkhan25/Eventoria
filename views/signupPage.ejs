<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Eventoria | User Signup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/output.css">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      body { font-family: 'Inter', sans-serif; }
      .background-image {
        background: url('/images/back.png') no-repeat center center;
        background-size: cover;
        position: fixed; top: 0; left: 0;
        height: 100vh; width: 100vw; z-index: -2;
      }
      .background-blur {
        backdrop-filter: blur(2px);
        background-color: rgba(0,0,0,0.4);
        position: fixed; top: 0; left: 0;
        height: 100vh; width: 100vw; z-index: -1;
      }
      @keyframes loginFade { from { opacity: 0; transform: scale(0.8) translateY(50px); } to { opacity: 1; transform: scale(1) translateY(0); } }
      .signup-animate { animation: loginFade 1s ease-out forwards; }
      @keyframes crazyExit {
        0% { transform: perspective(800px) rotateY(0deg) scale(1); opacity: 1; }
        50% { transform: perspective(800px) rotateY(90deg) scale(1.2); opacity: 0.6; }
        100% { transform: perspective(800px) rotateY(180deg) scale(0.3); opacity: 0; }
      }
      .submit-animate { animation: crazyExit 1.2s ease-in-out forwards; }
      .close-btn {
        position: absolute; top: 1rem; right: 2rem;
        font-size: 1.75rem; color: white;
        background: transparent; border: none;
        cursor: pointer; z-index: 20;
      }
      .input {
        width:100%;
        padding:0.75rem 1rem;
        border-radius:0.5rem;
        background: rgba(13,42,69,0.45);
        border:1px solid rgba(99,102,241,0.08);
        color: #fff;
      }
      .google-btn {
        display:flex; align-items:center; justify-content:center; gap:8px;
        background:#fff;color:#111;border-radius:999px;padding:10px 14px;
        cursor:pointer;font-weight:600;
      }
    </style>
  </head>

  <body class="min-h-screen flex items-center justify-center relative">
    <div id="navbar" class="fixed top-0 m-6 inset-x-0 z-50 transition-all duration-700 bg-transparent font-general">
      <nav class="flex items-center justify-between px-6 py-4">
        <!-- Logo -->
         <div class="flex items-center gap-3">
          <span class="text-white font-zentry text-xl">Eventoria</span>
        </div>
      </nav>
    </div>

    <div class="background-image"></div>
    <div class="background-blur"></div>

    <div class="relative bg-black/60 backdrop-blur-lg p-10 rounded-md shadow-2xl border border-blue-700 w-full max-w-md text-white signup-animate"
         id="user-signup-box">

      <button class="close-btn" onclick="window.location.href='/home'">&times;</button>

      <h2 class="text-4xl font-extrabold mb-6 text-center tracking-wide">User SignUp</h2>

      <form id="userSignupForm" class="space-y-4" onsubmit="return false;">
        <input type="text" name="username" placeholder="Full name" required class="input" />
        <input type="email" name="useremail" placeholder="Email address" required class="input" />
        <input type="password" name="password" placeholder="Password (min 6 chars)" required class="input" />
        <input type="password" name="confirmPassword" placeholder="Confirm password" required class="input" />

        <button id="userSubmitButton" type="button"
                class="px-4 py-2 bg-blue-700 text-white rounded-[2.5rem] hover:bg-blue-600 transition w-full">
          Create account
        </button>

        <div class="flex items-center gap-3">
          <div style="flex:1; height:1px; background:rgba(255,255,255,0.06)"></div>
          <div class="text-sm text-blue-300">or</div>
          <div style="flex:1; height:1px; background:rgba(255,255,255,0.06)"></div>
        </div>

        <div>
          <button id="googleSignUp" type="button" class="google-btn w-full">
            <svg width="18" height="18" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M44.5 20H24v8.5h11.9C34.2 32.3 29.6 36 24 36c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.3 0 6.2 1.2 8.5 3.2l6-6C34.5 3.6 29.6 1.5 24 1.5 11.9 1.5 2.5 10.9 2.5 23S11.9 44.5 24 44.5 45.5 35.1 45.5 23c0-1.5-.2-2.9-.6-4z" fill="#4285F4"/>
            </svg>
            Sign up with Google
          </button>
        </div>

        <div class="flex justify-between items-center text-sm text-blue-300 mt-3">
          <a href="/userlogin" class="hover:underline">Already Have Account?</a>
        </div>
      </form>

      <div class="mt-6 text-sm text-blue-300 text-center">
        <a href="/hostsignup" class="text-blue-400 font-medium hover:underline">Are you a Host?</a>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        updateProfile,
        signInWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCgQhUe2F6T59chhkPDHZ0QgjPJpe6Pz_0",
        authDomain: "eventoria-9da08.firebaseapp.com",
        projectId: "eventoria-9da08",
        storageBucket: "eventoria-9da08.firebasestorage.app",
        messagingSenderId: "1081916400444",
        appId: "1:1081916400444:web:f28cd875473e04b5bd3439",
        measurementId: "G-YE8TKZ66BX"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      const form = document.getElementById("userSignupForm");
      const btn = document.getElementById("userSubmitButton");
      const googleBtn = document.getElementById("googleSignUp");
      const box = document.getElementById("user-signup-box");

      async function sendIdTokenToServer(user) {
        const idToken = await user.getIdToken();
        await fetch("/sessionLogin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken })
        });
      }

      btn.addEventListener("click", async () => {
        const name = form.username.value.trim();
        const email = form.useremail.value.trim();
        const password = form.password.value;
        const confirm = form.confirmPassword.value;

        if (!name || !email || !password || !confirm) return alert("Please fill all fields.");
        if (password.length < 6) return alert("Password must be at least 6 characters.");
        if (password !== confirm) return alert("Passwords do not match.");

        try {
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(userCred.user, { displayName: name });
          await sendIdTokenToServer(userCred.user);
          alert("Account created and logged in.");
          box.classList.add("submit-animate");
          setTimeout(() => window.location.href = "/home", 900);
        } catch (err) {
          if (err.code === "auth/email-already-in-use") {
            try {
              const signInCred = await signInWithEmailAndPassword(auth, email, password);
              await sendIdTokenToServer(signInCred.user);
              alert("Existing account signed in.");
              box.classList.add("submit-animate");
              setTimeout(() => window.location.href = "/home", 900);
            } catch (signinErr) {
              alert(signinErr.message || "Email already in use. Try logging in.");
            }
          } else {
            alert(err.message || "Sign up failed.");
          }
        }
      });

      googleBtn.addEventListener("click", async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          await sendIdTokenToServer(user);
          alert("Signed in with Google.");
          box.classList.add("submit-animate");
          setTimeout(() => window.location.href = "/home", 900);
        } catch (err) {
          console.error(err);
          alert(err.message || "Google sign-in failed.");
        }
      });
    </script>
  </body>
</html>
